(()=>{function e(e){return null!==e&&"object"==typeof e}function t(e){if("number"==typeof e)return!0;if("string"!=typeof e)return!1;const t=Number(e);return Number.isInteger(t)&&String(t)===e}const r=Symbol("resonantProxy"),s=new WeakMap;class n{constructor(e,t,...r){const s=Array.from(r);return n._createArrayProxy(s,e,t,"")}static _ensureKey(t,r){if(e(t)){if(!s.has(t)){const e=""+r._nextKeyId++;s.set(t,e)}if(!Object.prototype.hasOwnProperty.call(t,"key"))try{Object.defineProperty(t,"key",{get:()=>s.get(t),enumerable:!1,configurable:!1})}catch(e){}}}static _ensureKeysRecursive(t,r){return e(t)?Array.isArray(t)?(t.forEach(e=>n._ensureKeysRecursive(e,r)),t):(n._ensureKey(t,r),Object.keys(t).forEach(e=>{n._ensureKeysRecursive(t[e],r)}),t):t}static _wrapAny(t,s,i,o){return e(t)?t[r]?t:Array.isArray(t)?n._createArrayProxy(t.slice(),s,i,o):i._createObject(s,t,o):t}static _createArrayProxy(s,i,o,a){try{Object.defineProperty(s,r,{value:!0,enumerable:!1})}catch(e){}for(let t=0;t<s.length;t++){const r=s[t];e(r)&&n._ensureKeysRecursive(r,o),s[t]=n._wrapAny(r,i,o,a?`${a}.${t}`:`${t}`)}const l=!(!a||!String(a).length),c=(e,t)=>{const r=l?"modified":"added";o._queueUpdate(i,r,e,null,void 0,t,a)},u=(e,t)=>{const r=l?"modified":"removed";o._queueUpdate(i,r,e,null,void 0,t,a)},d=(e,t,r,s=null)=>{o._queueUpdate(i,"modified",e,s,r,t,a)},p=(e=null)=>{const t=l?"modified":"updated",r=null!==e?e:s;o._queueUpdate(i,t,r,null,void 0,null,a)};return new Proxy(s,{get(e,s,l){if(s===r)return!0;if("length"===s)return Reflect.get(e,s,l);if("set"===s)return(t,r)=>{const s=Number(t),l=e[s],c=n._wrapAny(r,i,o,a?`${a}.${s}`:`${s}`);return n._ensureKeysRecursive(c,o),e[s]=c,d(e[s],s,l),!0};if("delete"===s)return t=>{const r=Number(t);if(!Object.prototype.hasOwnProperty.call(e,r))return!0;const s=e[r];return Array.prototype.splice.call(e,r,1),u(s,r),!0};if("update"===s)return t=>{const r=Array.isArray(t)?t:[];for(let t=e.length-1;t>=0;t--){const r=e[t];e.splice(t,1),u(r,t)}const s=r.map((e,t)=>{const r=n._wrapAny(e,i,o,a?`${a}.${t}`:`${t}`);return n._ensureKeysRecursive(r,o),r});Array.prototype.push.apply(e,s),s.forEach((e,t)=>c(e,t)),p(t)};if("filterInPlace"===s)return t=>{const r=e.filter(t);for(let t=e.length-1;t>=0;t--){const r=e[t];e.splice(t,1),u(r,t)}const s=r.map((e,t)=>{const r=n._wrapAny(e,i,o,a?`${a}.${t}`:`${t}`);return n._ensureKeysRecursive(r,o),r});return Array.prototype.push.apply(e,s),s.forEach((e,t)=>c(e,t)),p(),r};if("forceUpdate"===s)return()=>{n._ensureKeysRecursive(e,o),p()};const h={push:(...t)=>{const r=e.length,s=t.map((e,t)=>{const s=n._wrapAny(e,i,o,a?`${a}.${r+t}`:`${r+t}`);return n._ensureKeysRecursive(s,o),s}),l=Array.prototype.push.apply(e,s);return s.forEach((e,t)=>c(e,r+t)),l},pop:()=>{if(!e.length)return;const t=e.length-1,r=Array.prototype.pop.call(e);return u(r,t),r},unshift:(...t)=>{const r=t.map((e,t)=>{const r=n._wrapAny(e,i,o,a?`${a}.${t}`:`${t}`);return n._ensureKeysRecursive(r,o),r}),s=Array.prototype.unshift.apply(e,r);return r.forEach((e,t)=>c(e,t)),s},shift:()=>{if(!e.length)return;const t=Array.prototype.shift.call(e);return u(t,0),t},splice:(t,r,...s)=>{const l=Number(t)||0,d=void 0===r?e.length-l:Number(r),p=e.slice(l,l+d),h=s.map((e,t)=>{const r=n._wrapAny(e,i,o,a?`${a}.${l+t}`:`${l+t}`);return n._ensureKeysRecursive(r,o),r}),y=Array.prototype.splice.call(e,l,d,...h);return p.forEach((e,t)=>u(e,l+t)),h.forEach((e,t)=>c(e,l+t)),y},sort:t=>(Array.prototype.sort.call(e,t),l),reverse:()=>(Array.prototype.reverse.call(e),l),filter:(t,r=!0)=>{const s=Array.prototype.filter.call(e,t);return r&&o._queueUpdate(i,"filtered",void 0,null,void 0,null,a),s}};if(s in h)return h[s];if("symbol"==typeof s&&s===Symbol.iterator)return e[Symbol.iterator].bind(e);if(t(s))return Reflect.get(e,s,l);const y=Reflect.get(e,s,l);return"function"==typeof y?y.bind(e):y},set(e,r,s,l){if("length"===r){const t=Number(s);if(!Number.isInteger(t)||t<0)return!1;if(t<e.length){const n=e.slice(t);return Reflect.set(e,r,s,l),n.forEach((e,r)=>u(e,t+r)),!0}return Reflect.set(e,r,s,l)}if(t(r)){const t=Number(r),c=e[t],u=n._wrapAny(s,i,o,a?`${a}.${t}`:`${t}`);n._ensureKeysRecursive(u,o);const p=Reflect.set(e,r,u,l);return d(e[t],t,c),p}return Reflect.set(e,r,s,l)},deleteProperty(e,r){if(t(r)&&Object.prototype.hasOwnProperty.call(e,r)){const t=Number(r),s=e[t],n=Reflect.deleteProperty(e,r);return u(s,t),n}return Reflect.deleteProperty(e,r)}})}}window.Resonant=class{constructor(){this.data={},this.callbacks={},this.pendingUpdates=new Map,this.arrayDataChangeDetection={},this.computedProperties={},this.computedDependencies={},this._currentComputed=null,this._nextKeyId=1,this._changedArrayIndices={}}_splitPath(e){return"string"!=typeof e?[]:e.split(".").filter(Boolean)}_getRootAndPath(e){const t=this._splitPath(e);return{root:t.shift()||e,path:t.join(".")}}_getByPath(t){const{root:r,path:s}=this._getRootAndPath(t);let n=this.data[r];if(!s)return n;const i=this._splitPath(s);for(const t of i){if(!e(n))return;n=n[t]}return n}_setByPath(t,r){const{root:s,path:n}=this._getRootAndPath(t);if(!n)return void(window[s]=r);let i=this.data[s];const o=this._splitPath(n);for(let t=0;t<o.length-1;t++){const r=o[t];e(i[r])||(i[r]={}),i=i[r]}i[o[o.length-1]]=r}_handleInputElement(e,t,r){const s=(e.type||"").toLowerCase();if("checkbox"===s){const s=!!t;e.checked!==s&&(e.checked=s),e.hasAttribute("data-resonant-bound")||(e.onchange=()=>r(!!e.checked),e.setAttribute("data-resonant-bound","true"))}else if("number"===s||"range"===s){const s=t??"";e.value!==String(s)&&(e.value=s),e.hasAttribute("data-resonant-bound")||(e.oninput=()=>{const t=e.value,s=""===t?null:Number(t);r(Number.isNaN(s)?null:s)},e.setAttribute("data-resonant-bound","true"))}else{const s=t??"";e.value!==String(s)&&(e.value=s),e.hasAttribute("data-resonant-bound")||(e.oninput=()=>r(e.value),e.setAttribute("data-resonant-bound","true"))}}persist(e,t,r){if(!r)return t;try{const r=localStorage.getItem("res_"+e);return null!=r?JSON.parse(r):(localStorage.setItem("res_"+e,JSON.stringify(t)),t)}catch(r){return console.warn("Resonant: persistence error for",e,r),t}}updatePersistantData(e){try{localStorage.getItem("res_"+e)&&localStorage.setItem("res_"+e,JSON.stringify(this.data[e]))}catch(t){console.warn("Resonant: persistence update error for",e,t)}}add(t,r,s){r=this.persist(t,r,s),Array.isArray(r)?(this.data[t]=new n(t,this,...r),this.arrayDataChangeDetection[t]=Array.prototype.slice.call(this.data[t])):e(r)?this.data[t]=this._createObject(t,r,""):this.data[t]=r,this._defineProperty(t),this.updateElement(t)}addAll(e){Object.entries(e).forEach(([e,t])=>{this.add(e,t)})}computed(e,t){this.computedProperties[e]=t,this.computedDependencies[e]=new Set,this.computedDependencies[e].clear(),this._currentComputed=e;try{const r=t();this.data[e]=r,this._defineProperty(e),this.updateElement(e)}finally{this._currentComputed=null}}_captureAccess(e){this._currentComputed&&this.computedDependencies[this._currentComputed].add(e)}_recomputeProperty(e){if(!this.computedProperties[e])return;const t=this.computedProperties[e],r=this.data[e];this.computedDependencies[e].clear(),this._currentComputed=e;try{const s=t();r!==s&&(this.data[e]=s,this.updateElement(e),this._queueUpdate(e,"modified",s,null,r))}finally{this._currentComputed=null}}_resolveValue(e,t,r=null){return r??e[t]}_createObject(t,s,i=""){const o=this,a=(s,i)=>{if(!e(s))return s;if(s[r])return s;if(Array.isArray(s))return n._createArrayProxy(s.slice(),t,o,i);n._ensureKeysRecursive(s,o);const l={get(s,l,c){if(l===r)return!0;if(o._currentComputed&&"symbol"!=typeof l){const e=i?`${t}.${i}.${String(l)}`:`${t}.${String(l)}`;o._captureAccess(t),o._captureAccess(e)}const u=Reflect.get(s,l,c);if(e(u)){const e=i?`${i}.${String(l)}`:String(l);let c;return u[r]?u:(c=Array.isArray(u)?n._createArrayProxy(u,t,o,e):a(u,e),s[l]=c,c)}return u},set(e,r,s,l){const c=e[r];if(c===s)return!0;const u=i?`${i}.${String(r)}`:String(r),d=a(s,u);n._ensureKeysRecursive(d,o);const p=Reflect.set(e,r,d,l);return o._queueUpdate(t,"modified",e,String(r),c,null,u),p},deleteProperty(e,r){const s=e[r],n=Reflect.deleteProperty(e,r);return n&&o._queueUpdate(t,"removed",null,String(r),s,null,i?`${i}.${String(r)}`:String(r)),n}};try{Object.defineProperty(s,r,{value:!0,enumerable:!1})}catch(e){}return new Proxy(s,l)};return a(s,i)}_evaluateDisplayCondition(t,r,s,n){try{let i=s||"",o=!1;if(n){const{root:t}=this._getRootAndPath(n);if(r&&e(r)){const e=new RegExp(`\\b${t}\\b`,"g");i=i.replace(e,"item");(i.match(/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g)||[]).forEach(e=>{if("item"!==e&&"true"!==e&&"false"!==e&&"null"!==e&&"undefined"!==e&&Object.prototype.hasOwnProperty.call(r,e)){const t=new RegExp(`\\b${e}\\b`,"g");i=i.replace(t,`item.${e}`)}})}}try{o=!!new Function("item","state",`return (${i});`)(r,this.data)}catch(e){o=!!new Function(`return (${s});`)()}t.style.display=o?"inherit":"none"}catch(e){console.error(`Error evaluating display condition: ${s}`,e)}}_handleDisplayElements(e,t,r){e.querySelectorAll("[res-display]").forEach(e=>{const s=e.getAttribute("res-display")||"";this._evaluateDisplayCondition(e,t,s,r)})}_bindClickEvents(t,r,s){t.querySelectorAll("[res-onclick], [res-onclick-remove]").forEach(t=>{const n=t.getAttribute("res-onclick"),i=t.getAttribute("res-onclick-remove");n&&(t.onclick=()=>{const e=window&&window[n]||null;if("function"==typeof e)try{e.length>0?e(r):e()}catch(e){console.error("Resonant: onclick handler error for",n,e)}else console.warn("Resonant: onclick handler not found:",n)}),i&&(t.onclick=()=>{if(s&&Array.isArray(s)){const t=s.findIndex(t=>e(t)&&t[i]===r[i]);-1!==t&&s.splice(t,1)}})})}_defineProperty(t){Object.defineProperty(window,t,{configurable:!0,get:()=>(this._captureAccess(t),this.data[t]),set:r=>{this.computedProperties[t]?console.warn(`Cannot set computed property "${t}"`):(Array.isArray(r)?(this.data[t]=new n(t,this,...r),this.arrayDataChangeDetection[t]=Array.prototype.slice.call(this.data[t])):e(r)?this.data[t]=this._createObject(t,r,""):this.data[t]=r,this.updateElement(t),this.updateDisplayConditionalsFor(t),this.updateStylesFor(t),Array.isArray(r)||e(r)||this._queueUpdate(t,"modified",this.data[t]))}})}_queueUpdate(e,t,r,s=null,n,i=null,o=null){if(this.pendingUpdates.has(e)||this.pendingUpdates.set(e,[]),this.pendingUpdates.get(e).push({action:t,item:r,property:s,oldValue:n,index:i,path:o}),this._changedArrayIndices[e]||(this._changedArrayIndices[e]=new Set),"number"==typeof i&&i>=0)this._changedArrayIndices[e].add(i);else if("string"==typeof o){const t=o.match(/^(\d+)(\.|$)/);t&&this._changedArrayIndices[e].add(Number(t[1]))}1===this.pendingUpdates.get(e).length&&setTimeout(()=>{let t=this.pendingUpdates.get(e)||[];this.updatePersistantData(e),this.pendingUpdates.delete(e);const r=new Map;t.forEach(e=>r.set((e=>`${e.action}|${e.property??""}|${e.index??""}|${e.path??""}`)(e),e)),t=Array.from(r.values()),t.forEach(t=>{this._triggerCallbacks(e,t)});const s=new Set;t.forEach(t=>{s.add(e),t.path&&s.add(`${e}.${t.path}`)}),Object.keys(this.computedDependencies).forEach(t=>{const r=this.computedDependencies[t];for(const n of s)if(r.has(n)||r.has(e)){this._recomputeProperty(t);break}}),this.updateElement(e),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e),this._changedArrayIndices[e]&&delete this._changedArrayIndices[e]},0)}_triggerCallbacks(e,t){this.callbacks[e]&&this.callbacks[e].forEach(r=>{const s=t.item||t.oldValue;try{r("undefined"!=typeof window&&void 0!==window[e]?window[e]:this.data[e],s,t.action)}catch(t){console.error("Resonant: callback error for",e,t)}})}updateElement(t){const{root:r}=this._getRootAndPath(t);document.querySelectorAll(`[res="${r}"], [res^="${r}."]`).forEach(t=>{const r=t.getAttribute("res"),s=this._getByPath(r);if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)this._handleInputElement(t,s,e=>{this._setByPath(r,e);const{root:t,path:s}=this._getRootAndPath(r);this._queueUpdate(t,"modified",this._getByPath(r),s?s.split(".").pop():null,null,null,s||null)});else if(Array.isArray(s)){if("true"===t.getAttribute("res-rendered"))return;t.querySelectorAll(`[res="${r}"][res-rendered="true"]`).forEach(e=>e.remove()),this._renderArray(r,t)}else if(e(s)){t.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");t&&t in s&&this._renderObjectProperty(e,s[t],r,t)})}else t.innerHTML=s??""}),this.updateDisplayConditionalsFor(t),this.updateStylesFor(t)}_renderObjectProperty(t,r,s,n){const i=t.tagName;if("INPUT"!==i&&"TEXTAREA"!==i||Array.isArray(r)||e(r))if(Array.isArray(r)){let n=null;const i=this._getByPath(s);if(i&&e(i))try{n=i.key}catch(e){}else{const e=t.getAttribute("res-child");e&&e.includes("--")&&(n=e.split("--")[1])}this._renderNestedArray(t,r,n,s)}else if(e(r)){t.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");t&&t in r&&this._renderObjectProperty(e,r[t],s,t)})}else t.innerHTML=r??"";else{const e=`${s}.${n}`;this._handleInputElement(t,r,t=>{this._setByPath(e,t)})}}_renderArray(t,r){const s=this._getByPath(t),n=r.hasAttribute("res")&&r.parentElement?r.parentElement:r;let i;const o=t+"_template";window[o]?i=window[o]:(i=r.cloneNode(!0),window[o]=i,r.style.display="none",r.setAttribute("res-template","true"));const a=new Map;n.querySelectorAll(`[res="${t}"][res-rendered="true"]`).forEach(e=>{const t=e.getAttribute("res-key");t&&a.set(t,e)}),n.querySelectorAll(`[res="${t}"][res-rendered="true"]`).forEach(e=>e.remove()),s.forEach((r,o)=>{let l,c=null;try{c=r&&r.key}catch(e){}c||(c=String(o));const u=this._changedArrayIndices[t]||this._changedArrayIndices[this._getRootAndPath(t).root];if(a.has(c)&&!(u&&u.has(o))?(l=a.get(c),a.delete(c),l.setAttribute("res-index",o)):(l=i.cloneNode(!0),l.removeAttribute("res-template"),l.style.display="",l.setAttribute("res-rendered","true"),l.setAttribute("res-key",c),l.setAttribute("res",t)),l.setAttribute("res-index",o),e(r)){Object.keys(r).forEach(n=>{let i=null,a=l.querySelector(`[res-prop="${n}"]`);if(a||(a=l.querySelector('[res-prop=""]'),i=r),a){const l=this._resolveValue(r,n,i),c=a.tagName;if("INPUT"!==c&&"TEXTAREA"!==c||Array.isArray(l)||e(l))if(Array.isArray(l)){let e=null;try{e=s[o]?.key}catch(e){}this._renderNestedArray(a,l,e,t)}else if(e(l)){a.querySelectorAll("[res-prop]").forEach(e=>{const r=e.getAttribute("res-prop");r&&r in l&&this._renderObjectProperty(e,l[r],t,`${o}.${r}`)})}else a.innerHTML=l??"";else{const e=l;this._handleInputElement(a,l,s=>{r[n]=s,this._queueUpdate(this._getRootAndPath(t).root,"modified",r,n,e,o,`${o}.${n}`)})}}})}else{const e=l.querySelector('[res-prop=""]');e?e.innerHTML=String(r):l.innerHTML=String(r)}this._handleDisplayElements(l,r,t),this._bindClickEvents(l,r,s),n.appendChild(l)})}_renderNestedArray(t,r,s,n){t.__res_template||(t.__res_template=t.cloneNode(!0));const i=t.__res_template;for(t.innerHTML="";t.children&&t.children.length;)t.children[0].remove();r.forEach((o,a)=>{const l=i.cloneNode(!0);if(l.setAttribute("res-rendered","true"),l.setAttribute("res-index",a),null===o||e(o)){l.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");if(t&&t in o){let r=null;try{r=o.key}catch(e){}e.setAttribute("res-child",(r?`${r}-`:"")+t+"--"+(s||"")),this._renderObjectProperty(e,o[t],n,t)}});const e=l.getAttribute("res-display");e&&this._evaluateDisplayCondition(l,o,e,n),this._handleDisplayElements(l,o,n),this._bindClickEvents(l,o,r)}else l.innerHTML=o;t.appendChild(l)})}updateDisplayConditionalsFor(e){document.querySelectorAll(`[res-display*="${e}"]`).forEach(t=>{const r=t.getAttribute("res-display");let s=null,n=t;for(;n;){const e=n.getAttribute&&n.getAttribute("res"),t=n.getAttribute&&n.getAttribute("res-index");if(e){const r=this._getByPath(e);if(Array.isArray(r)&&null!=t){s=r[Number(t)];break}s=r;break}n=n.parentElement}this._evaluateDisplayCondition(t,s??this.data[e],r,e)});document.querySelectorAll(`[res="${e}"] [res-display]`).forEach(t=>{const r=t.getAttribute("res-display");this._evaluateDisplayCondition(t,this.data[e],r,e)})}updateStylesFor(e){document.querySelectorAll(`[res-style*="${e}"]`).forEach(t=>{let r=t.getAttribute("res-style");try{const e=t.getAttribute("res-styles");e&&(e.split(/\s+/).filter(Boolean).forEach(e=>t.classList.remove(e)),t.removeAttribute("res-styles"));let s=t,n=null,i=null;for(;s;){const e=s.getAttribute&&s.getAttribute("res"),t=s.getAttribute&&s.getAttribute("res-index");e&&(n=e),null!=t&&(i=t),s=s.parentElement}let o=null;if(n){const e=this._getByPath(n);o=Array.isArray(e)&&null!==i?e[Number(i)]:e}let a=r;if(n){const{root:e}=this._getRootAndPath(n),t=new RegExp(`\\b${e}\\b`,"g");a=a.replace(t,"item")}const l=new Function("item","state",`return (${a});`)(o,this.data);"string"==typeof l&&l.trim()&&(l.split(/\s+/).forEach(e=>t.classList.add(e)),t.setAttribute("res-styles",l.trim()))}catch(t){console.error(`Error evaluating style for ${e}: ${r}`,t)}})}addCallback(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}},window.ObservableArray=n})();
//# sourceMappingURL=resonant.min.js.map