(()=>{function e(e){return null!==e&&"object"==typeof e}function t(e){if("number"==typeof e)return!0;if("string"!=typeof e)return!1;const t=Number(e);return Number.isInteger(t)&&String(t)===e}const r=Symbol("resonantProxy"),n=new WeakMap;class s{constructor(e,t,...r){const n=Array.from(r);return s._createArrayProxy(n,e,t,"")}static _ensureKey(t,r){if(e(t)){if(!n.has(t)){const e=""+r._nextKeyId++;n.set(t,e)}if(!Object.prototype.hasOwnProperty.call(t,"key"))try{Object.defineProperty(t,"key",{get:()=>n.get(t),enumerable:!1,configurable:!1})}catch(e){}}}static _ensureKeysRecursive(t,r,n=new WeakSet){return e(t)?n.has(t)?t:(n.add(t),Array.isArray(t)?(t.forEach(e=>s._ensureKeysRecursive(e,r,n)),t):(s._ensureKey(t,r),Object.keys(t).forEach(e=>{s._ensureKeysRecursive(t[e],r,n)}),t)):t}static _wrapAny(t,n,i,o){return e(t)?t[r]?t:Array.isArray(t)?s._createArrayProxy(t.slice(),n,i,o):i._createObject(n,t,o):t}static _createArrayProxy(n,i,o,a){try{Object.defineProperty(n,r,{value:!0,enumerable:!1})}catch(e){}for(let t=0;t<n.length;t++){const r=n[t];e(r)&&s._ensureKeysRecursive(r,o),n[t]=s._wrapAny(r,i,o,a?`${a}.${t}`:`${t}`)}const l=!(!a||!String(a).length),c=(e,t)=>{const r=l?"modified":"added";o._queueUpdate(i,r,e,null,void 0,t,a)},u=(e,t)=>{const r=l?"modified":"removed";o._queueUpdate(i,r,e,null,void 0,t,a)},d=(e,t,r,n=null)=>{o._queueUpdate(i,"modified",e,n,r,t,a)},p=(e=null)=>{const t=l?"modified":"updated",r=null!==e?e:n;o._queueUpdate(i,t,r,null,void 0,null,a)};return new Proxy(n,{get(e,n,l){if(n===r)return!0;if("length"===n)return Reflect.get(e,n,l);if("set"===n)return(t,r)=>{const n=Number(t),l=e[n],c=s._wrapAny(r,i,o,a?`${a}.${n}`:`${n}`);return s._ensureKeysRecursive(c,o),e[n]=c,d(e[n],n,l),!0};if("delete"===n)return t=>{const r=Number(t);if(!Object.prototype.hasOwnProperty.call(e,r))return!0;const n=e[r];return Array.prototype.splice.call(e,r,1),u(n,r),!0};if("update"===n)return t=>{const r=Array.isArray(t)?t:[];for(let t=e.length-1;t>=0;t--){const r=e[t];e.splice(t,1),u(r,t)}const n=r.map((e,t)=>{const r=s._wrapAny(e,i,o,a?`${a}.${t}`:`${t}`);return s._ensureKeysRecursive(r,o),r});Array.prototype.push.apply(e,n),n.forEach((e,t)=>c(e,t)),p(t)};if("filterInPlace"===n)return t=>{const r=e.filter(t);for(let t=e.length-1;t>=0;t--){const r=e[t];e.splice(t,1),u(r,t)}const n=r.map((e,t)=>{const r=s._wrapAny(e,i,o,a?`${a}.${t}`:`${t}`);return s._ensureKeysRecursive(r,o),r});return Array.prototype.push.apply(e,n),n.forEach((e,t)=>c(e,t)),p(),r};if("forceUpdate"===n)return()=>{s._ensureKeysRecursive(e,o),p()};const h={push:(...t)=>{const r=e.length,n=t.map((e,t)=>{const n=s._wrapAny(e,i,o,a?`${a}.${r+t}`:`${r+t}`);return s._ensureKeysRecursive(n,o),n}),l=Array.prototype.push.apply(e,n);return n.forEach((e,t)=>c(e,r+t)),l},pop:()=>{if(!e.length)return;const t=e.length-1,r=Array.prototype.pop.call(e);return u(r,t),r},unshift:(...t)=>{const r=t.map((e,t)=>{const r=s._wrapAny(e,i,o,a?`${a}.${t}`:`${t}`);return s._ensureKeysRecursive(r,o),r}),n=Array.prototype.unshift.apply(e,r);return r.forEach((e,t)=>c(e,t)),n},shift:()=>{if(!e.length)return;const t=Array.prototype.shift.call(e);return u(t,0),t},splice:(t,r,...n)=>{const l=Number(t)||0,d=void 0===r?e.length-l:Number(r),p=e.slice(l,l+d),h=n.map((e,t)=>{const r=s._wrapAny(e,i,o,a?`${a}.${l+t}`:`${l+t}`);return s._ensureKeysRecursive(r,o),r}),y=Array.prototype.splice.call(e,l,d,...h);return p.forEach((e,t)=>u(e,l+t)),h.forEach((e,t)=>c(e,l+t)),y},sort:t=>(Array.prototype.sort.call(e,t),l),reverse:()=>(Array.prototype.reverse.call(e),l),filter:(t,r=!0)=>{const n=Array.prototype.filter.call(e,t);return r&&o._queueUpdate(i,"filtered",void 0,null,void 0,null,a),n}};if(n in h)return h[n];if("symbol"==typeof n&&n===Symbol.iterator)return e[Symbol.iterator].bind(e);if(t(n))return Reflect.get(e,n,l);const y=Reflect.get(e,n,l);return"function"==typeof y?y.bind(e):y},set(e,r,n,l){if("length"===r){const t=Number(n);if(!Number.isInteger(t)||t<0)return!1;if(t<e.length){const s=e.slice(t);return Reflect.set(e,r,n,l),s.forEach((e,r)=>u(e,t+r)),!0}return Reflect.set(e,r,n,l)}if(t(r)){const t=Number(r),c=e[t],u=s._wrapAny(n,i,o,a?`${a}.${t}`:`${t}`);s._ensureKeysRecursive(u,o);const p=Reflect.set(e,r,u,l);return d(e[t],t,c),p}return Reflect.set(e,r,n,l)},deleteProperty(e,r){if(t(r)&&Object.prototype.hasOwnProperty.call(e,r)){const t=Number(r),n=e[t],s=Reflect.deleteProperty(e,r);return u(n,t),s}return Reflect.deleteProperty(e,r)}})}}window.Resonant=class{constructor(){this.data={},this.callbacks={},this.pendingUpdates=new Map,this.arrayDataChangeDetection={},this.computedProperties={},this.computedDependencies={},this._currentComputed=null,this._nextKeyId=1,this._changedArrayIndices={}}_splitPath(e){return"string"!=typeof e?[]:e.split(".").filter(Boolean)}_getRootAndPath(e){const t=this._splitPath(e);return{root:t.shift()||e,path:t.join(".")}}_getByPath(t){const{root:r,path:n}=this._getRootAndPath(t);let s=this.data[r];if(!n)return s;const i=this._splitPath(n);for(const t of i){if(!e(s))return;s=s[t]}return s}_setByPath(t,r){const{root:n,path:s}=this._getRootAndPath(t);if(!s)return void(window[n]=r);let i=this.data[n];const o=this._splitPath(s);for(let t=0;t<o.length-1;t++){const r=o[t];e(i[r])||(i[r]={}),i=i[r]}i[o[o.length-1]]=r}_handleInputElement(e,t,r){const n=(e.type||"").toLowerCase();if("checkbox"===n){const n=!!t;e.checked!==n&&(e.checked=n),e.hasAttribute("data-resonant-bound")||(e.onchange=()=>r(!!e.checked),e.setAttribute("data-resonant-bound","true"))}else if("number"===n||"range"===n){const n=t??"";e.value!==String(n)&&(e.value=n),e.hasAttribute("data-resonant-bound")||(e.oninput=()=>{const t=e.value,n=""===t?null:Number(t);r(Number.isNaN(n)?null:n)},e.setAttribute("data-resonant-bound","true"))}else{const n=t??"";e.value!==String(n)&&(e.value=n),e.hasAttribute("data-resonant-bound")||(e.oninput=()=>r(e.value),e.setAttribute("data-resonant-bound","true"))}}persist(e,t,r){if(!r)return t;try{const r=localStorage.getItem("res_"+e);return null!=r?JSON.parse(r):(localStorage.setItem("res_"+e,JSON.stringify(t)),t)}catch(r){return console.warn("Resonant: persistence error for",e,r),t}}updatePersistantData(e){try{localStorage.getItem("res_"+e)&&localStorage.setItem("res_"+e,JSON.stringify(this.data[e]))}catch(t){console.warn("Resonant: persistence update error for",e,t)}}add(t,r,n){(r=this.persist(t,r,n))&&r.constructor&&"Response"===r.constructor.name?r.json().then(e=>{this.add(t,e,n)}).catch(e=>{console.error(`Resonant: Error resolving fetch response for variable "${t}":`,e)}):r instanceof Promise?r.then(e=>{this.add(t,e,n)}).catch(e=>{console.error(`Resonant: Error resolving promise for variable "${t}":`,e)}):(Array.isArray(r)?(this.data[t]=new s(t,this,...r),this.arrayDataChangeDetection[t]=Array.prototype.slice.call(this.data[t])):e(r)?this.data[t]=this._createObject(t,r,""):this.data[t]=r,this._defineProperty(t),this.updateElement(t))}addAll(e){Object.entries(e).forEach(([e,t])=>{this.add(e,t)})}bind(e,t){if("string"!=typeof e)return void console.error("Resonant.bind: variableName must be a string");if(!(e in window))return void console.warn(`Resonant.bind: variable "${e}" not found in window scope`);const r=window[e];this.add(e,r,t)}computed(e,t){this.computedProperties[e]=t,this.computedDependencies[e]=new Set,this.computedDependencies[e].clear(),this._currentComputed=e;try{const r=t();this.data[e]=r,this._defineProperty(e),this.updateElement(e)}finally{this._currentComputed=null}}_captureAccess(e){this._currentComputed&&this.computedDependencies[this._currentComputed].add(e)}_recomputeProperty(e){if(!this.computedProperties[e])return;const t=this.computedProperties[e],r=this.data[e];this.computedDependencies[e].clear(),this._currentComputed=e;try{const n=t();r!==n&&(this.data[e]=n,this.updateElement(e),this._queueUpdate(e,"modified",n,null,r))}finally{this._currentComputed=null}}_resolveValue(e,t,r=null){return r??e[t]}_createObject(t,n,i=""){const o=this,a=(n,i)=>{if(!e(n))return n;if(n[r])return n;if(Array.isArray(n))return s._createArrayProxy(n.slice(),t,o,i);s._ensureKeysRecursive(n,o);const l={get(n,l,c){if(l===r)return!0;if(o._currentComputed&&"symbol"!=typeof l){const e=i?`${t}.${i}.${String(l)}`:`${t}.${String(l)}`;o._captureAccess(t),o._captureAccess(e)}const u=Reflect.get(n,l,c);if(e(u)){const e=i?`${i}.${String(l)}`:String(l);let c;return u[r]?u:(c=Array.isArray(u)?s._createArrayProxy(u,t,o,e):a(u,e),n[l]=c,c)}return u},set(e,r,n,l){const c=e[r];if(c===n)return!0;const u=i?`${i}.${String(r)}`:String(r),d=a(n,u);s._ensureKeysRecursive(d,o);const p=Reflect.set(e,r,d,l);return o._queueUpdate(t,"modified",e,String(r),c,null,u),p},deleteProperty(e,r){const n=e[r],s=Reflect.deleteProperty(e,r);return s&&o._queueUpdate(t,"removed",null,String(r),n,null,i?`${i}.${String(r)}`:String(r)),s}};try{Object.defineProperty(n,r,{value:!0,enumerable:!1})}catch(e){}return new Proxy(n,l)};return a(n,i)}_evaluateDisplayCondition(t,r,n,s){try{let i=n||"",o=!1;if(s){const{root:t}=this._getRootAndPath(s);if(r&&e(r)){const e=new RegExp(`\\b${t}\\b`,"g");i=i.replace(e,"item");(i.match(/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g)||[]).forEach(e=>{if("item"!==e&&"true"!==e&&"false"!==e&&"null"!==e&&"undefined"!==e&&Object.prototype.hasOwnProperty.call(r,e)){const t=new RegExp(`\\b${e}\\b`,"g");i=i.replace(t,`item.${e}`)}})}}try{o=!!new Function("item","state",`return (${i});`)(r,this.data)}catch(e){o=!!new Function(`return (${n});`)()}t.style.display=o?"inherit":"none"}catch(e){console.error(`Error evaluating display condition: ${n}`,e)}}_handleDisplayElements(e,t,r){e.querySelectorAll("[res-display]").forEach(e=>{const n=e.getAttribute("res-display")||"";this._evaluateDisplayCondition(e,t,n,r)})}_bindClickEvents(t,r,n){t.querySelectorAll("[res-onclick], [res-onclick-remove]").forEach(t=>{const s=t.getAttribute("res-onclick"),i=t.getAttribute("res-onclick-remove");s&&(t.onclick=()=>{const e=window&&window[s]||null;if("function"==typeof e)try{e.length>0?e(r):e()}catch(e){console.error("Resonant: onclick handler error for",s,e)}else console.warn("Resonant: onclick handler not found:",s)}),i&&(t.onclick=()=>{if(n&&Array.isArray(n)){const t=n.findIndex(t=>e(t)&&t[i]===r[i]);-1!==t&&n.splice(t,1)}})})}_defineProperty(t){Object.defineProperty(window,t,{configurable:!0,get:()=>(this._captureAccess(t),this.data[t]),set:r=>{this.computedProperties[t]?console.warn(`Cannot set computed property "${t}"`):(Array.isArray(r)?(this.data[t]=new s(t,this,...r),this.arrayDataChangeDetection[t]=Array.prototype.slice.call(this.data[t])):e(r)?this.data[t]=this._createObject(t,r,""):this.data[t]=r,this.updateElement(t),this.updateDisplayConditionalsFor(t),this.updateStylesFor(t),Array.isArray(r)||e(r)||this._queueUpdate(t,"modified",this.data[t]))}})}_queueUpdate(e,t,r,n=null,s,i=null,o=null){if(this.pendingUpdates.has(e)||this.pendingUpdates.set(e,[]),this.pendingUpdates.get(e).push({action:t,item:r,property:n,oldValue:s,index:i,path:o}),this._changedArrayIndices[e]||(this._changedArrayIndices[e]=new Set),"number"==typeof i&&i>=0)this._changedArrayIndices[e].add(i);else if("string"==typeof o){const t=o.match(/^(\d+)(\.|$)/);t&&this._changedArrayIndices[e].add(Number(t[1]))}1===this.pendingUpdates.get(e).length&&setTimeout(()=>{let t=this.pendingUpdates.get(e)||[];this.updatePersistantData(e),this.pendingUpdates.delete(e);const r=new Map;t.forEach(e=>r.set((e=>`${e.action}|${e.property??""}|${e.index??""}|${e.path??""}`)(e),e)),t=Array.from(r.values()),t.forEach(t=>{this._triggerCallbacks(e,t)});const n=new Set;t.forEach(t=>{n.add(e),t.path&&n.add(`${e}.${t.path}`)}),Object.keys(this.computedDependencies).forEach(t=>{const r=this.computedDependencies[t];for(const s of n)if(r.has(s)||r.has(e)){this._recomputeProperty(t);break}}),this.updateElement(e),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e),this._changedArrayIndices[e]&&delete this._changedArrayIndices[e]},0)}_triggerCallbacks(e,t){this.callbacks[e]&&this.callbacks[e].forEach(r=>{const n=t.item||t.oldValue;try{r("undefined"!=typeof window&&void 0!==window[e]?window[e]:this.data[e],n,t.action)}catch(t){console.error("Resonant: callback error for",e,t)}})}updateElement(t){const{root:r}=this._getRootAndPath(t);document.querySelectorAll(`[res="${r}"], [res^="${r}."]`).forEach(t=>{const r=t.getAttribute("res"),n=this._getByPath(r);if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)this._handleInputElement(t,n,e=>{this._setByPath(r,e);const{root:t,path:n}=this._getRootAndPath(r);this._queueUpdate(t,"modified",this._getByPath(r),n?n.split(".").pop():null,null,null,n||null)});else if(Array.isArray(n)){if("true"===t.getAttribute("res-rendered"))return;t.querySelectorAll(`[res="${r}"][res-rendered="true"]`).forEach(e=>e.remove()),this._renderArray(r,t)}else if(e(n)){t.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");t&&t in n&&this._renderObjectProperty(e,n[t],r,t)})}else t.innerHTML=n??""}),this.updateDisplayConditionalsFor(t),this.updateStylesFor(t)}_renderObjectProperty(t,r,n,s){const i=t.tagName;if("INPUT"!==i&&"TEXTAREA"!==i||Array.isArray(r)||e(r))if(Array.isArray(r)){let s=null;const i=this._getByPath(n);if(i&&e(i))try{s=i.key}catch(e){}else{const e=t.getAttribute("res-child");e&&e.includes("--")&&(s=e.split("--")[1])}this._renderNestedArray(t,r,s,n)}else if(e(r)){t.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");t&&t in r&&this._renderObjectProperty(e,r[t],n,t)})}else t.innerHTML=r??"";else{const e=`${n}.${s}`;this._handleInputElement(t,r,t=>{this._setByPath(e,t)})}}_renderArray(t,r){const n=this._getByPath(t),s=r.hasAttribute("res")&&r.parentElement?r.parentElement:r;let i;const o=t+"_template";window[o]?i=window[o]:(i=r.cloneNode(!0),window[o]=i,r.style.display="none",r.setAttribute("res-template","true"));const a=new Map,l=Array.from(s.querySelectorAll(`[res="${t}"][res-rendered="true"]`));l.forEach(e=>{const t=e.getAttribute("res-key");t&&a.set(t,e)});const c=this._changedArrayIndices[t]||this._changedArrayIndices[this._getRootAndPath(t).root],u=new Set;n.forEach((r,o)=>{let l,d=null;try{d=r&&r.key}catch(e){}d||(d=String(o));let p=a.has(d)&&!(c&&c.has(o));if(p?(l=a.get(d),u.add(l),l.setAttribute("res-index",o)):(l=i.cloneNode(!0),l.removeAttribute("res-template"),l.style.display="",l.setAttribute("res-rendered","true"),l.setAttribute("res-key",d),l.setAttribute("res",t)),l.setAttribute("res-index",o),!p)if(e(r)){Object.keys(r).forEach(n=>{let s=null,i=l.querySelector(`[res-prop="${n}"]`);if(i||(i=l.querySelector('[res-prop=""]'),s=r),i){const a=this._resolveValue(r,n,s),l=i.tagName;if("INPUT"!==l&&"TEXTAREA"!==l||Array.isArray(a)||e(a))Array.isArray(a)||e(a)||(i.innerHTML=a??"");else{const e=a;this._handleInputElement(i,a,s=>{r[n]=s,this._queueUpdate(this._getRootAndPath(t).root,"modified",r,n,e,o,`${o}.${n}`)})}}})}else{const e=l.querySelector('[res-prop=""]');e?e.innerHTML=String(r):l.innerHTML=String(r)}if(e(r)){Object.keys(r).forEach(s=>{let i=l.querySelector(`[res-prop="${s}"]`);if(i){const a=this._resolveValue(r,s,null);if(Array.isArray(a)){let e=null;try{e=n[o]?.key}catch(e){}this._renderNestedArray(i,a,e,t)}else if(e(a)){i.querySelectorAll("[res-prop]").forEach(e=>{const r=e.getAttribute("res-prop");r&&r in a&&this._renderObjectProperty(e,a[r],t,`${o}.${r}`)})}}})}this._handleDisplayElements(l,r,t),this._bindClickEvents(l,r,n),s.appendChild(l)}),l.forEach(e=>{u.has(e)||e.remove()})}_renderNestedArray(t,r,n,s){t.__res_template||(t.__res_template=t.cloneNode(!0));const i=t.__res_template;for(t.innerHTML="";t.children&&t.children.length;)t.children[0].remove();r.forEach((o,a)=>{const l=i.cloneNode(!0);if(l.setAttribute("res-rendered","true"),l.setAttribute("res-index",a),null===o||e(o)){l.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");if(t&&t in o){let r=null;try{r=o.key}catch(e){}e.setAttribute("res-child",(r?`${r}-`:"")+t+"--"+(n||"")),this._renderObjectProperty(e,o[t],s,t)}});const e=l.getAttribute("res-display");e&&this._evaluateDisplayCondition(l,o,e,s),this._handleDisplayElements(l,o,s),this._bindClickEvents(l,o,r)}else l.innerHTML=o;t.appendChild(l)})}updateDisplayConditionalsFor(e){document.querySelectorAll(`[res-display*="${e}"]`).forEach(t=>{const r=t.getAttribute("res-display");let n=null,s=t;for(;s;){const e=s.getAttribute&&s.getAttribute("res"),t=s.getAttribute&&s.getAttribute("res-index");if(e){const r=this._getByPath(e);if(Array.isArray(r)&&null!=t){n=r[Number(t)];break}n=r;break}s=s.parentElement}this._evaluateDisplayCondition(t,n??this.data[e],r,e)});document.querySelectorAll(`[res="${e}"] [res-display]`).forEach(t=>{const r=t.getAttribute("res-display");this._evaluateDisplayCondition(t,this.data[e],r,e)})}updateStylesFor(e){document.querySelectorAll(`[res-style*="${e}"]`).forEach(t=>{let r=t.getAttribute("res-style");try{const e=t.getAttribute("res-styles");e&&(e.split(/\s+/).filter(Boolean).forEach(e=>t.classList.remove(e)),t.removeAttribute("res-styles"));let n=t,s=null,i=null;for(;n;){const e=n.getAttribute&&n.getAttribute("res"),t=n.getAttribute&&n.getAttribute("res-index");e&&(s=e),null!=t&&(i=t),n=n.parentElement}let o=null;if(s){const e=this._getByPath(s);o=Array.isArray(e)&&null!==i?e[Number(i)]:e}let a=r;if(s){const{root:e}=this._getRootAndPath(s),t=new RegExp(`\\b${e}\\b`,"g");a=a.replace(t,"item")}const l=new Function("item","state",`return (${a});`)(o,this.data);"string"==typeof l&&l.trim()&&(l.split(/\s+/).forEach(e=>t.classList.add(e)),t.setAttribute("res-styles",l.trim()))}catch(t){console.error(`Error evaluating style for ${e}: ${r}`,t)}})}addCallback(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}},window.ObservableArray=s})();
//# sourceMappingURL=resonant.min.js.map