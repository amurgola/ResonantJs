class ObservableArray extends Array{constructor(e,t,...s){if(void 0===t)return super(...s);super(...s);var r=void 0===t.data[e];this.variableName=e,this.resonantInstance=t,this.isDeleting=!1,this.forEach((e,t)=>{"object"==typeof e&&(this._setKeyForObjectAndChildObjects(e,t),this[t]=this._createProxy(e,t))}),r||this.forceUpdate()}_setKeyForObjectAndChildObjects(e,t){"object"==typeof e&&(e.key=t+"-"+this._generateKeyByContentCheckSum(e),Object.keys(e).forEach(s=>{this._setKeyForObjectAndChildObjects(e[s],t)}))}_generateKeyByContentCheckSum(e){const t=e=>{if(!e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>t(e));const s={...e};return delete s.key,Object.keys(s).forEach(e=>{"object"==typeof s[e]&&null!==s[e]&&(s[e]=t(s[e]))}),s},s=t(e),r=JSON.stringify(s);let a=0;for(let e=0;e<r.length;e++){a=(a<<5)-a+r.charCodeAt(e),a&=a}return Math.abs(a).toString(36)}_wrapNestedObjects(e,t){return e&&"object"==typeof e&&!e.__resonantProxy?(Object.keys(e).forEach(s=>{e[s]=this._wrapNestedObjects(e[s],t)}),e.__resonantProxy=!0,new Proxy(e,{set:(s,r,a)=>{if(s[r]!==a){const i=s[r];s[r]=this._wrapNestedObjects(a,t),this._setKeyForObjectAndChildObjects(e,t),this.resonantInstance._queueUpdate(this.variableName,"modified",s,r,i,t)}return!0}})):e}_createProxy(e,t){return this._wrapNestedObjects(e,t)}forceUpdate(){this.forEach((e,t)=>{this._setKeyForObjectAndChildObjects(e,t)}),this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),this.resonantInstance._queueUpdate(this.variableName,"modified",this.slice())}update(e){window[this.variableName]=e,this.resonantInstance._queueUpdate(this.variableName,"updated",e)}push(...e){e=e.map((e,t)=>"object"==typeof e?(this._setKeyForObjectAndChildObjects(e,this.length+t),this._createProxy(e,this.length+t)):e);const t=super.push(...e);return this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),e.forEach((e,t)=>{this.resonantInstance._queueUpdate(this.variableName,"added",e,this.length-1-t)}),t}splice(e,t,...s){s=s.map((t,s)=>"object"==typeof t?this._createProxy(t,e+s):t);const r=super.splice(e,t,...s);return this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),t>0&&r.forEach((t,s)=>{this.resonantInstance._queueUpdate(this.variableName,"removed",t,e+s)}),s.length>0&&s.forEach((t,s)=>{this.resonantInstance._queueUpdate(this.variableName,"added",t,e+s)}),r}set(e,t){if(this[e]!==t){if(this.isDeleting)return!0;const s=this.resonantInstance.arrayDataChangeDetection[this.variableName];let r="modified";(e>=s.length||void 0===s[e])&&(r="added"),this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice();const a=this[e];this[e]=t,this.resonantInstance._queueUpdate(this.variableName,r,this[e],e,a)}return!0}delete(e){const t=this[e];return this.isDeleting=!0,this.splice(e,1),this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),this.resonantInstance._queueUpdate(this.variableName,"removed",null,e,t),this.isDeleting=!1,!0}filter(e,t=!0){if(void 0===this.resonantInstance||!1===t)return super.filter(e);const s=super.filter(e);return this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),this.resonantInstance._queueUpdate(this.variableName,"filtered"),s}}class Resonant{constructor(){this.data={},this.callbacks={},this.pendingUpdates=new Map,this.arrayDataChangeDetection={}}_handleInputElement(e,t,s){"checkbox"===e.type?(e.checked=t,e.hasAttribute("data-resonant-bound")||(e.onchange=()=>s(e.checked),e.setAttribute("data-resonant-bound","true"))):(e.value=t,e.hasAttribute("data-resonant-bound")||(e.oninput=()=>s(e.value),e.setAttribute("data-resonant-bound","true")))}add(e,t,s){t=this.persist(e,t,s),Array.isArray(t)?(this.data[e]=new ObservableArray(e,this,...t),this.arrayDataChangeDetection[e]=this.data[e].slice()):this.data[e]="object"==typeof t&&null!==t?this._createObject(e,t):t,this._defineProperty(e),this.updateElement(e)}persist(e,t,s){if(void 0===s||!s)return t;var r=localStorage.getItem("res_"+e);return null!=r?JSON.parse(r):(localStorage.setItem("res_"+e,JSON.stringify(t)),t)}updatePersistantData(e){localStorage.getItem("res_"+e)&&localStorage.setItem("res_"+e,JSON.stringify(this.data[e]))}addAll(e){Object.entries(e).forEach(([e,t])=>{this.add(e,t)})}_resolveValue(e,t,s=null){return s??e[t]}_createObject(e,t){const s=t=>t&&"object"==typeof t&&!t.__resonantProxy?(Object.keys(t).forEach(e=>{t[e]=s(t[e])}),t.__resonantProxy=!0,new Proxy(t,{set:(t,r,a)=>{if(t[r]!==a){const i=t[r];t[r]=s(a),this._queueUpdate(e,"modified",t,r,i)}return!0}})):t;return s(t)}_evaluateDisplayCondition(e,t,s){try{let r=e.parentElement,a=null,i=null;for(;r&&!a;)a=r.getAttribute("res"),i||(i=r.getAttribute("res-index")),r=r.parentElement;if(a&&null!==i&&Array.isArray(this.data[a])&&(t=this.data[a][i]),a&&!s.includes(a+".")){(s.match(/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g)||[]).forEach(e=>{if("=="===e||"!="===e||!(e in t))return;const r=new RegExp(`\\b${e}\\b`,"g"),i=t[e];void 0!==i&&(void 0!==t["item."+e]?s=s.replace(r,`item.${e}`):"object"==typeof i&&(s=s.replace(r,`${a}.${e}`)))})}let n=!1;try{n=new Function("item",`return ${s}`)(t)}catch(e){const r=s.indexOf("."),a=s.substring(r+1);n=new Function("item",`return item.${a}`)(t)}e.style.display=n?"inherit":"none"}catch(e){console.error(`Error evaluating display condition: ${s}`,e)}}_handleDisplayElements(e,t){e.querySelectorAll("[res-display]").forEach(e=>{const s=e.getAttribute("res-display")||"";this._evaluateDisplayCondition(e,t,s)})}_bindClickEvents(e,t,s){e.querySelectorAll("[res-onclick], [res-onclick-remove]").forEach(e=>{const r=e.getAttribute("res-onclick"),a=e.getAttribute("res-onclick-remove");r&&(e.onclick=()=>{new Function("item",`return ${r}(item)`)(t)}),a&&(e.onclick=()=>{if(s){const e=s.findIndex(e=>e[a]===t[a]);-1!==e&&s.splice(e,1)}})})}_defineProperty(e){Object.defineProperty(window,e,{get:()=>this.data[e],set:t=>{Array.isArray(t)?(this.data[e]=new ObservableArray(e,this,...t),this.arrayDataChangeDetection[e]=this.data[e].slice()):this.data[e]="object"==typeof t&&null!==t?this._createObject(e,t):t,this.updateElement(e),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e),Array.isArray(t)||"object"==typeof t&&null!==t||this._queueUpdate(e,"modified",this.data[e])}})}_queueUpdate(e,t,s,r,a){this.pendingUpdates.has(e)||this.pendingUpdates.set(e,[]),this.pendingUpdates.get(e).push({action:t,item:s,property:r,oldValue:a}),1===this.pendingUpdates.get(e).length&&setTimeout(()=>{let t=this.pendingUpdates.get(e);this.updatePersistantData(e),this.pendingUpdates.delete(e),t=t.filter((e,t,s)=>s.findIndex(t=>t.property===e.property&&t.action===e.action)===t),t.forEach(t=>{this._triggerCallbacks(e,t)}),this.updateElement(e),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e)},0)}_triggerCallbacks(e,t){this.callbacks[e]&&this.callbacks[e].forEach(s=>{const r=t.item||t.oldValue;s(this.data[e],r,t.action)})}updateElement(e){const t=document.querySelectorAll(`[res="${e}"]`),s=this.data[e];t.forEach(t=>{if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)this._handleInputElement(t,s,t=>{this.data[e]=t,this._queueUpdate(e,"modified",this.data[e])});else if(Array.isArray(s)){if("true"===t.getAttribute("res-rendered"))return;t.querySelectorAll(`[res="${e}"][res-rendered="true"]`).forEach(e=>e.remove()),this._renderArray(e,t)}else if("object"==typeof s&&null!==s){t.querySelectorAll("[res-prop]").forEach(t=>{const r=t.getAttribute("res-prop");r&&r in s&&this._renderObjectProperty(t,s[r],e,r)})}else t.innerHTML=s??""}),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e)}_renderObjectProperty(e,t,s,r){if("INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||Array.isArray(t)||"object"==typeof t)if(Array.isArray(t)){let r=null;if(s&&this.data[s])r=this.data[s].key;else{const t=e.getAttribute("res-child");t&&t.includes("--")&&(r=t.split("--")[1])}this._renderNestedArray(e,t,r)}else if("object"==typeof t&&null!==t){e.querySelectorAll("[res-prop]").forEach(e=>{const r=e.getAttribute("res-prop");r&&r in t&&this._renderObjectProperty(e,t[r],s,r)})}else e.innerHTML=t??"";else this._handleInputElement(e,t,e=>{window[s][r]=e})}_renderArray(e,t){const s=t.hasAttribute("res")&&t.parentElement?t.parentElement:t;let r;window[e+"_template"]?r=window[e+"_template"]:(r=t.cloneNode(!0),window[e+"_template"]=r,t.style.display="none",t.setAttribute("res-template","true"));const a=new Map;s.querySelectorAll(`[res="${e}"][res-rendered="true"]`).forEach(e=>{const t=e.getAttribute("res-key");t&&a.set(t,e)}),s.querySelectorAll(`[res="${e}"][res-rendered="true"]`).forEach(e=>e.remove()),this.data[e].forEach((t,i)=>{const n=t.key;let l;a.has(n)?(l=a.get(n),a.delete(n),l.setAttribute("res-index",i)):(l=r.cloneNode(!0),l.removeAttribute("res-template"),l.style.display="",l.setAttribute("res-rendered","true"),l.setAttribute("res-key",n)),l.setAttribute("res-index",i);for(let s in t){let r=null,a=l.querySelector(`[res-prop="${s}"]`);if(a||(a=l.querySelector('[res-prop=""]'),r=t),a){const n=this._resolveValue(t,s,r);if("INPUT"!==a.tagName&&"TEXTAREA"!==a.tagName||Array.isArray(n)||"object"==typeof n)if(Array.isArray(n)){let t=this.data[e][i].key;this._renderNestedArray(a,n,t)}else if("object"==typeof n&&null!==n){a.querySelectorAll("[res-prop]").forEach(t=>{const s=t.getAttribute("res-prop");s&&s in n&&this._renderObjectProperty(t,n[s],e,s)})}else a.innerHTML=n??"";else this._handleInputElement(a,n,r=>{t[s]=r,this._queueUpdate(e,"modified",t,s,n)})}}this._handleDisplayElements(l,t),this._bindClickEvents(l,t,this.data[e]),s.appendChild(l)})}_renderNestedArray(e,t,s){e.__res_template||(e.__res_template=e.cloneNode(!0));const r=e.__res_template;for(e.innerHTML="";e.children&&e.children.length;)e.children[0].remove();t.forEach(a=>{const i=r.cloneNode(!0);if(i.setAttribute("res-rendered","true"),null!==a&&"object"!=typeof a)i.innerHTML=a;else{i.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");t&&t in a&&(e.setAttribute("res-child",a.key+"-"+t+"--"+s),this._renderObjectProperty(e,a[t],null,t))}),this._handleDisplayElements(i,a),this._bindClickEvents(i,a,t);const e=i.getAttribute("res-display");e&&this._evaluateDisplayCondition(i,a,e)}e.appendChild(i)})}updateDisplayConditionalsFor(e){document.querySelectorAll(`[res-display*="${e}"]`).forEach(t=>{const s=t.getAttribute("res-display");this._evaluateDisplayCondition(t,this.data[e],s)});document.querySelectorAll(`[res="${e}"] [res-display]`).forEach(t=>{const s=t.getAttribute("res-display");this._evaluateDisplayCondition(t,this.data[e],s)})}updateStylesFor(variableName){const styleElements=document.querySelectorAll(`[res-style*="${variableName}"]`);styleElements.forEach(styleElement=>{let styleCondition=styleElement.getAttribute("res-style");try{let parent=styleElement,index=null;for(;parent&&!index;)index=parent.getAttribute("res-index"),parent=parent.parentElement;let resStyles=styleElement.getAttribute("res-styles");if(resStyles){let e=resStyles.split(" ");e.forEach(e=>{styleElement.classList.remove(e)})}if(null!==index){const e=this.data[variableName][index];styleCondition=styleCondition.replace(new RegExp(`\\b${variableName}\\b`,"g"),"item");const t=new Function("item",`return ${styleCondition}`)(e);if(t)styleElement.classList.add(t);else{const e=styleElement.classList.contains(t);e&&styleElement.classList.remove(t)}}else{const styleClass=eval(styleCondition);if(styleClass)styleElement.classList.add(styleClass),styleElement.setAttribute("res-styles",styleClass);else{const e=styleElement.classList.contains(styleClass);e&&styleElement.classList.remove(styleClass)}}}catch(e){console.error(`Error evaluating style for ${variableName}: ${styleCondition}`,e)}})}addCallback(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}}