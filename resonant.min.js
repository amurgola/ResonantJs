class ObservableArray extends Array{constructor(e,t,...r){if(void 0===t)return super(...r);super(...r);var s=void 0===t.data[e];this.variableName=e,this.resonantInstance=t,this.isDeleting=!1,this.forEach((e,t)=>{"object"==typeof e&&(this._setKeyForObjectAndChildObjects(e,t),this[t]=this._createProxy(e,t))}),s||this.forceUpdate()}_setKeyForObjectAndChildObjects(e,t){"object"==typeof e&&(e.key=t+"-"+this._generateKeyByContentCheckSum(e),Object.keys(e).forEach(r=>{this._setKeyForObjectAndChildObjects(e[r],t)}))}_generateKeyByContentCheckSum(e){const t=e=>{if(!e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>t(e));const r={...e};return delete r.key,Object.keys(r).forEach(e=>{"object"==typeof r[e]&&null!==r[e]&&(r[e]=t(r[e]))}),r},r=t(e),s=JSON.stringify(r);let a=0;for(let e=0;e<s.length;e++){a=(a<<5)-a+s.charCodeAt(e),a&=a}return Math.abs(a).toString(36)}_wrapNestedObjects(e,t){return e&&"object"==typeof e&&!e.__resonantProxy?(Object.keys(e).forEach(r=>{e[r]=this._wrapNestedObjects(e[r],t)}),e.__resonantProxy=!0,new Proxy(e,{set:(r,s,a)=>{if(r[s]!==a){const i=r[s];r[s]=this._wrapNestedObjects(a,t),this._setKeyForObjectAndChildObjects(e,t),this.resonantInstance._queueUpdate(this.variableName,"modified",r,s,i,t)}return!0}})):e}_createProxy(e,t){return this._wrapNestedObjects(e,t)}forceUpdate(){this.forEach((e,t)=>{this._setKeyForObjectAndChildObjects(e,t)}),this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),this.resonantInstance._queueUpdate(this.variableName,"modified",this.slice())}update(e){window[this.variableName]=e,this.resonantInstance._queueUpdate(this.variableName,"updated",e)}push(...e){e=e.map((e,t)=>"object"==typeof e?(this._setKeyForObjectAndChildObjects(e,this.length+t),this._createProxy(e,this.length+t)):e);const t=super.push(...e);return this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),e.forEach((e,t)=>{this.resonantInstance._queueUpdate(this.variableName,"added",e,this.length-1-t)}),t}splice(e,t,...r){r=r.map((t,r)=>"object"==typeof t?this._createProxy(t,e+r):t);const s=super.splice(e,t,...r);return this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),t>0&&s.forEach((t,r)=>{this.resonantInstance._queueUpdate(this.variableName,"removed",t,e+r)}),r.length>0&&r.forEach((t,r)=>{this.resonantInstance._queueUpdate(this.variableName,"added",t,e+r)}),s}set(e,t){if(this[e]!==t){if(this.isDeleting)return!0;const r=this.resonantInstance.arrayDataChangeDetection[this.variableName];let s="modified";(e>=r.length||void 0===r[e])&&(s="added"),this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice();const a=this[e];this[e]=t,this.resonantInstance._queueUpdate(this.variableName,s,this[e],e,a)}return!0}delete(e){const t=this[e];return this.isDeleting=!0,this.splice(e,1),this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),this.resonantInstance._queueUpdate(this.variableName,"removed",null,e,t),this.isDeleting=!1,!0}filter(e,t=!0){if(void 0===this.resonantInstance||!1===t)return super.filter(e);const r=super.filter(e);return this.resonantInstance.arrayDataChangeDetection[this.variableName]=this.slice(),this.resonantInstance._queueUpdate(this.variableName,"filtered"),r}}class Resonant{constructor(){this.data={},this.callbacks={},this.pendingUpdates=new Map,this.arrayDataChangeDetection={},this.computedProperties={},this.computedDependencies={}}_handleInputElement(e,t,r){"checkbox"===e.type?(e.checked=t,e.hasAttribute("data-resonant-bound")||(e.onchange=()=>r(e.checked),e.setAttribute("data-resonant-bound","true"))):(e.value=t,e.hasAttribute("data-resonant-bound")||(e.oninput=()=>r(e.value),e.setAttribute("data-resonant-bound","true")))}add(e,t,r){t=this.persist(e,t,r),Array.isArray(t)?(this.data[e]=new ObservableArray(e,this,...t),this.arrayDataChangeDetection[e]=this.data[e].slice()):this.data[e]="object"==typeof t&&null!==t?this._createObject(e,t):t,this._defineProperty(e),this.updateElement(e)}persist(e,t,r){if(void 0===r||!r)return t;var s=localStorage.getItem("res_"+e);return null!=s?JSON.parse(s):(localStorage.setItem("res_"+e,JSON.stringify(t)),t)}updatePersistantData(e){localStorage.getItem("res_"+e)&&localStorage.setItem("res_"+e,JSON.stringify(this.data[e]))}addAll(e){Object.entries(e).forEach(([e,t])=>{this.add(e,t)})}computed(e,t){this.computedProperties[e]=t,this.computedDependencies[e]=new Set,this.computedDependencies[e].clear(),this._currentComputed=e;try{const r=t();this.data[e]=r,this._defineProperty(e),this.updateElement(e)}finally{this._currentComputed=null}}_captureAccess(e){this._currentComputed&&this.data.hasOwnProperty(e)&&this.computedDependencies[this._currentComputed].add(e)}_recomputeProperty(e){if(this.computedProperties[e]){const t=this.computedProperties[e],r=this.data[e];this.computedDependencies[e].clear(),this._currentComputed=e;try{const s=t();r!==s&&(this.data[e]=s,this.updateElement(e),this._queueUpdate(e,"modified",s,null,r))}finally{this._currentComputed=null}}}_resolveValue(e,t,r=null){return r??e[t]}_createObject(e,t){const r=t=>t&&"object"==typeof t&&!t.__resonantProxy?(Object.keys(t).forEach(e=>{t[e]=r(t[e])}),t.__resonantProxy=!0,new Proxy(t,{set:(t,s,a)=>{if(t[s]!==a){const i=t[s];t[s]=r(a),this._queueUpdate(e,"modified",t,s,i)}return!0}})):t;return r(t)}_evaluateDisplayCondition(e,t,r){try{let s=e.parentElement,a=null,i=null;for(;s&&!a;)a=s.getAttribute("res"),i||(i=s.getAttribute("res-index")),s=s.parentElement;if(a&&null!==i&&Array.isArray(this.data[a])&&(t=this.data[a][i]),a&&!r.includes(a+".")){(r.match(/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g)||[]).forEach(e=>{if("=="===e||"!="===e||!(e in t))return;const s=new RegExp(`\\b${e}\\b`,"g"),i=t[e];void 0!==i&&(void 0!==t["item."+e]?r=r.replace(s,`item.${e}`):"object"==typeof i&&(r=r.replace(s,`${a}.${e}`)))})}let n=!1;try{n=new Function("item",`return ${r}`)(t)}catch(e){const s=r.indexOf("."),a=r.substring(s+1);n=new Function("item",`return item.${a}`)(t)}e.style.display=n?"inherit":"none"}catch(e){console.error(`Error evaluating display condition: ${r}`,e)}}_handleDisplayElements(e,t){e.querySelectorAll("[res-display]").forEach(e=>{const r=e.getAttribute("res-display")||"";this._evaluateDisplayCondition(e,t,r)})}_bindClickEvents(e,t,r){e.querySelectorAll("[res-onclick], [res-onclick-remove]").forEach(e=>{const s=e.getAttribute("res-onclick"),a=e.getAttribute("res-onclick-remove");s&&(e.onclick=()=>{new Function("item",`return ${s}(item)`)(t)}),a&&(e.onclick=()=>{if(r){const e=r.findIndex(e=>e[a]===t[a]);-1!==e&&r.splice(e,1)}})})}_defineProperty(e){Object.defineProperty(window,e,{get:()=>(this._currentComputed&&this._captureAccess(e),this.data[e]),set:t=>{this.computedProperties[e]?console.warn(`Cannot set computed property "${e}"`):(Array.isArray(t)?(this.data[e]=new ObservableArray(e,this,...t),this.arrayDataChangeDetection[e]=this.data[e].slice()):this.data[e]="object"==typeof t&&null!==t?this._createObject(e,t):t,this.updateElement(e),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e),Array.isArray(t)||"object"==typeof t&&null!==t||this._queueUpdate(e,"modified",this.data[e]))}})}_queueUpdate(e,t,r,s,a){this.pendingUpdates.has(e)||this.pendingUpdates.set(e,[]),this.pendingUpdates.get(e).push({action:t,item:r,property:s,oldValue:a}),1===this.pendingUpdates.get(e).length&&setTimeout(()=>{let t=this.pendingUpdates.get(e);this.updatePersistantData(e),this.pendingUpdates.delete(e),t=t.filter((e,t,r)=>r.findIndex(t=>t.property===e.property&&t.action===e.action)===t),t.forEach(t=>{this._triggerCallbacks(e,t)}),this.updateElement(e),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e),Object.keys(this.computedDependencies).forEach(t=>{this.computedDependencies[t].has(e)&&this._recomputeProperty(t)})},0)}_triggerCallbacks(e,t){this.callbacks[e]&&this.callbacks[e].forEach(r=>{const s=t.item||t.oldValue;r(this.data[e],s,t.action)})}updateElement(e){const t=document.querySelectorAll(`[res="${e}"]`),r=this.data[e];t.forEach(t=>{if("INPUT"===t.tagName||"TEXTAREA"===t.tagName)this._handleInputElement(t,r,t=>{this.data[e]=t,this._queueUpdate(e,"modified",this.data[e])});else if(Array.isArray(r)){if("true"===t.getAttribute("res-rendered"))return;t.querySelectorAll(`[res="${e}"][res-rendered="true"]`).forEach(e=>e.remove()),this._renderArray(e,t)}else if("object"==typeof r&&null!==r){t.querySelectorAll("[res-prop]").forEach(t=>{const s=t.getAttribute("res-prop");s&&s in r&&this._renderObjectProperty(t,r[s],e,s)})}else t.innerHTML=r??""}),this.updateDisplayConditionalsFor(e),this.updateStylesFor(e)}_renderObjectProperty(e,t,r,s){if("INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||Array.isArray(t)||"object"==typeof t)if(Array.isArray(t)){let s=null;if(r&&this.data[r])s=this.data[r].key;else{const t=e.getAttribute("res-child");t&&t.includes("--")&&(s=t.split("--")[1])}this._renderNestedArray(e,t,s)}else if("object"==typeof t&&null!==t){e.querySelectorAll("[res-prop]").forEach(e=>{const s=e.getAttribute("res-prop");s&&s in t&&this._renderObjectProperty(e,t[s],r,s)})}else e.innerHTML=t??"";else this._handleInputElement(e,t,e=>{window[r][s]=e})}_renderArray(e,t){const r=t.hasAttribute("res")&&t.parentElement?t.parentElement:t;let s;window[e+"_template"]?s=window[e+"_template"]:(s=t.cloneNode(!0),window[e+"_template"]=s,t.style.display="none",t.setAttribute("res-template","true"));const a=new Map;r.querySelectorAll(`[res="${e}"][res-rendered="true"]`).forEach(e=>{const t=e.getAttribute("res-key");t&&a.set(t,e)}),r.querySelectorAll(`[res="${e}"][res-rendered="true"]`).forEach(e=>e.remove()),this.data[e].forEach((t,i)=>{const n=t.key;let o;a.has(n)?(o=a.get(n),a.delete(n),o.setAttribute("res-index",i)):(o=s.cloneNode(!0),o.removeAttribute("res-template"),o.style.display="",o.setAttribute("res-rendered","true"),o.setAttribute("res-key",n)),o.setAttribute("res-index",i);for(let r in t){let s=null,a=o.querySelector(`[res-prop="${r}"]`);if(a||(a=o.querySelector('[res-prop=""]'),s=t),a){const n=this._resolveValue(t,r,s);if("INPUT"!==a.tagName&&"TEXTAREA"!==a.tagName||Array.isArray(n)||"object"==typeof n)if(Array.isArray(n)){let t=this.data[e][i].key;this._renderNestedArray(a,n,t)}else if("object"==typeof n&&null!==n){a.querySelectorAll("[res-prop]").forEach(t=>{const r=t.getAttribute("res-prop");r&&r in n&&this._renderObjectProperty(t,n[r],e,r)})}else a.innerHTML=n??"";else this._handleInputElement(a,n,s=>{t[r]=s,this._queueUpdate(e,"modified",t,r,n)})}}this._handleDisplayElements(o,t),this._bindClickEvents(o,t,this.data[e]),r.appendChild(o)})}_renderNestedArray(e,t,r){e.__res_template||(e.__res_template=e.cloneNode(!0));const s=e.__res_template;for(e.innerHTML="";e.children&&e.children.length;)e.children[0].remove();t.forEach(a=>{const i=s.cloneNode(!0);if(i.setAttribute("res-rendered","true"),null!==a&&"object"!=typeof a)i.innerHTML=a;else{i.querySelectorAll("[res-prop]").forEach(e=>{const t=e.getAttribute("res-prop");t&&t in a&&(e.setAttribute("res-child",a.key+"-"+t+"--"+r),this._renderObjectProperty(e,a[t],null,t))}),this._handleDisplayElements(i,a),this._bindClickEvents(i,a,t);const e=i.getAttribute("res-display");e&&this._evaluateDisplayCondition(i,a,e)}e.appendChild(i)})}updateDisplayConditionalsFor(e){document.querySelectorAll(`[res-display*="${e}"]`).forEach(t=>{const r=t.getAttribute("res-display");this._evaluateDisplayCondition(t,this.data[e],r)});document.querySelectorAll(`[res="${e}"] [res-display]`).forEach(t=>{const r=t.getAttribute("res-display");this._evaluateDisplayCondition(t,this.data[e],r)})}updateStylesFor(e){const t=document.querySelectorAll(`[res-style*="${e}"]`);t.forEach(t=>{let r=t.getAttribute("res-style");try{let s=t,a=null;for(;s&&!a;)a=s.getAttribute("res-index"),s=s.parentElement;let i=t.getAttribute("res-styles");if(i){let e=i.split(" ");e.forEach(e=>{t.classList.remove(e)})}if(null!==a){const s=this.data[e][a];r=r.replace(new RegExp(`\\b${e}\\b`,"g"),"item");const i=new Function("item",`return ${r}`)(s);if(i)t.classList.add(i);else{const e=t.classList.contains(i);e&&t.classList.remove(i)}}else{const e=eval(r);if(e)t.classList.add(e),t.setAttribute("res-styles",e);else{const r=t.classList.contains(e);r&&t.classList.remove(e)}}}catch(t){console.error(`Error evaluating style for ${e}: ${r}`,t)}})}addCallback(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}}
//# sourceMappingURL=resonant.min.js.map